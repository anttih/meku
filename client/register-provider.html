<!DOCTYPE html>
<html>
<head>
  <link href="vendor/normalize-3.0.1.css" media="all" rel="stylesheet" />
  <link href="style.css" media="all" rel="stylesheet" />
  <script src="vendor/jquery-2.1.1.min.js"></script>
  <script src="vendor/lodash-2.4.1.min.js"></script>
  <script src="js/shared.js"></script>
  <script>
    if (location.hostname == 'localhost') { var s = document.createElement('script'); s.src='http://localhost:35729/livereload.js'; document.head.appendChild(s) }
  </script>
  <script>
    $(function() {
      registerRevisionMismatchAjaxErrorHandler()

      var $form = $('form')
      var $button = $form.find('button')
      var $feedback = $form.find('.feedback')
      var $invalid = $feedback.find('.invalid')
      var $error = $feedback.find('.error')
      var $success = $feedback.find('.success')

      $.get('/environment', function(res) {
        if (res.environment === 'training') {
          $('.training-ribbon').show()
          $('a.xls').prop('href', 'KAVI-koulutus-tarjoajaksi-ilmoittautuminen.xls')
        }
      })

      $button.on('click', function(e) {
        e.preventDefault()

        $button.prop('disabled', true)

        $.ajax({
          url: '/files/provider-import',
          data: new FormData($form.get(0)),
          cache: false,
          contentType: false,
          processData: false,
          type: 'POST',
          success: function(data) {
            $invalid.toggle(!!data.error)
            $success.toggle(!data.error)
            $error.hide()
            if (data.error) {
              var errors = _.map(data.error.messages, function (error) {
                return $('<li>').text(error)
              })

              $invalid.find('ul').html(errors)
              $button.prop('disabled', false)
            } else {
              $success.text(data.message)
              $form.find('.fields').hide()
            }
          },
          error: function() {
            $error.show()
            $button.prop('disabled', false)
          }
        })
      })

      $form.on('change', function() {
        $button.prop('disabled', _.isEmpty($form.find('input[name=providerFile]').val()))
      })
    })
  </script>
  <title>Kuvaohjelmien luokittelu- ja valvontajärjestelmä</title>
</head>
<body id="register-provider-page">
  <div class="training-ribbon"><span>Koulutusympäristö</span></div>
  <div id="header">
    <div class="content">
      <div>
        <h1>Kuvaohjelmien luokittelu- ja valvontajärjestelmä</h1>
      </div>
    </div>
  </div>
  <form enctype="multipart/form-data">
    <h2>Tarjoajaksi ilmoittautuminen</h2>
    <div class="fields">
      <p>
        Ilmoittaudu kuvaohjelmatarjoajaksi täyttämällä Excel-taulukko tarjoajan
        tiedoista sekä tarjoamispaikoista, ja lähettämällä se alla olevalla lomakkeella.
        Lataa ilmoittautumislomake <a class="xls" href="KAVI-tarjoajaksi-ilmoittautuminen.xls">tästä</a>.
      </p>
      <div>
        <label for="message">Viesti Kaville</label>
        <p class="help">Tähän kenttään voit tarvittaessa kirjoittaa kommentit tai pyynnöt
        Kaville. Esim. Milloin kuvaohjelmien tarjonta aloitetaan?</p>
        <textarea name="message" id="message"></textarea></label>
        <label>Valitse taulukko-tiedosto <input type="file" name="providerFile" /></label>
      </div>
      <div>
        <button class="button" disabled>Lähetä tiedosto</button>
      </div>
    </div>
    <div class="feedback">
      <p class="success hidden"></p>
      <p class="error hidden">Tiedoston lähettäminen ei onnistunut.</p>
      <div class="invalid hidden">
        <p>Tarjoajan tai tarjoajan tiedoista puuttui pakollisia tietoja. Ole
        hyvä, täytä puuttuvat tiedot ja lähetä tiedosto uudelleen.</p>
        <ul></ul>
      </div>
    </div>
  </form>
  <div id="overlay"></div>
  <div id="dialog"></div>
</body>
</html>
